# Implementation Plan: Subscription-Level ARM Template Migration

**Version**: 1.0.12 (from current v1.0.11)
**Approach**: Option A - Subscription-level deployment with enhanced safety mechanisms
**Date**: 2025-10-17
**Status**: In Progress

## Executive Summary

### Background
Current v1.0.11 uses resource group-level ARM template deployment, which cannot deploy subscription-level resources (activity log diagnostic settings). Attempts to use nested deployments failed due to Azure's scope transition restrictions.

### Problem Statement
- Activity log diagnostic settings must be deployed at subscription scope
- Resource group deployments cannot create subscription-level resources
- Current nested deployment approach is architecturally impossible
- Users must manually configure activity logs post-deployment

### Solution Overview
Migrate to subscription-level ARM template that:
1. Deploys at subscription scope using `subscriptionDeploymentTemplate.json#` schema
2. **Requires existing resource group** (user must pre-create)
3. Deploys activity log diagnostic settings directly at subscription level
4. Uses nested deployment to create Event Hub and storage resources in existing resource group

### Expected Benefits
- ✅ Automatic activity log configuration (no manual steps)
- ✅ Single-click deployment fully automated
- ✅ Proper Azure architecture (correct scope hierarchy)
- ✅ Simpler template (no resource group creation logic)
- ✅ Better user experience

### Migration Risks & Mitigation
- **Risk**: No built-in rollback for subscription deployments
  - **Mitigation**: What-if testing, cleanup scripts, comprehensive documentation
- **Risk**: Breaking change for CLI users
  - **Mitigation**: Clear migration guide, updated examples
- **Risk**: Complex nested deployment structure
  - **Mitigation**: Thorough testing, validation scripts
- **Risk**: Diagnostic settings limit (5 per subscription)
  - **Mitigation**: Unique timestamped names

## Technical Architecture

### Current Architecture (v1.0.11)

```
Resource Group Deployment (az deployment group create)
├── Event Hub Namespace
├── Event Hub
├── Consumer Groups
├── Authorization Rules (Send, Listen)
├── Storage Account
├── Blob Container (edgedelta-checkpoints)
└── ❌ Activity Logs Diagnostic Settings (nested deployment - FAILS)
```

**Schema**: `https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#`
**Scope**: Resource Group
**Command**: `az deployment group create`
**Problem**: Cannot deploy subscription-level diagnostic settings

### Target Architecture (v1.0.12)

```
Subscription Deployment (az deployment sub create)
├── ✅ Activity Log Diagnostic Settings (subscription scope)
│   ├── eventHubAuthorizationRuleId
│   ├── eventHubName
│   └── log categories (Administrative, Security, etc.)
└── Nested Deployment (targets EXISTING resource group)
    ├── Event Hub Namespace
    ├── Event Hub
    ├── Consumer Groups
    ├── Authorization Rules (Send, Listen)
    ├── Storage Account
    └── Blob Container
```

**Schema**: `https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#`
**Scope**: Subscription
**Command**: `az deployment sub create`
**Benefit**: Diagnostic settings deploy successfully at correct scope
**Prerequisite**: Resource group must exist before deployment

## Detailed Implementation Checklist

### Phase 0: Preparation & Setup

- [x] Create `specs/` directory
- [x] Create `specs/plan-2025-10-17.md` with full checklist
- [ ] Create new branch `daniel-edgedelta/subscription-level-template`
- [ ] Review current v1.0.11 template structure
- [ ] Document current outputs for compatibility check
- [ ] Create backup tag `v1.0.11-final` in git

### Phase 1: Main Template Restructuring

#### Schema & Metadata (5 tasks)
- [ ] Change `$schema` to `https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#`
- [ ] Update `contentVersion` to `1.0.12.0`
- [ ] Update `metadata.version` to `1.0.12.0`
- [ ] Update `metadata.description` to mention subscription-level deployment
- [ ] Update `dateUpdated` to `2025-10-17`

#### Parameters (4 tasks)
- [ ] Add `resourceGroupName` parameter (string, required) - must be existing RG
- [ ] Update `configureActivityLogs` default back to `true`
- [ ] Add description mentioning subscription-level deployment requires existing RG
- [ ] Keep all existing parameters (location, namespace, storage, etc.)

#### Variables (3 tasks)
- [ ] Change `diagnosticSettingName` to use timestamp: `[concat('edgedelta-activity-logs-', utcNow('yyyyMMddHHmmss'))]`
- [ ] Keep all existing variables
- [ ] Add `resourceGroupId` variable for reference

#### Resources (10 tasks)
- [ ] Move diagnostic settings to root level (no nesting)
- [ ] Update diagnostic settings to use subscription schema
- [ ] Create nested deployment for resource group resources
- [ ] Move Event Hub namespace into nested deployment
- [ ] Move all child resources into nested deployment
- [ ] Move storage account into nested deployment
- [ ] Move blob container into nested deployment
- [ ] Update `resourceGroup` property in nested deployment to reference existing RG
- [ ] Set nested deployment to use `Inner` scope evaluation
- [ ] Remove problematic old nested deployment for activity logs (lines 212-299)

#### Outputs (6 tasks)
- [ ] Update all `resourceId` references to use nested deployment output
- [ ] Ensure `connectionString` output works from nested deployment
- [ ] Ensure storage outputs work from nested deployment
- [ ] Keep all existing outputs for backward compatibility
- [ ] Add `resourceGroupName` output
- [ ] Update `activityLogsConfigured` message

### Phase 2: UI Definition Updates

#### Basics Section (3 tasks)
- [ ] Add existing resource group selector to basics section (Microsoft.Solutions.ResourceSelector)
- [ ] Add info box explaining RG must exist before deployment
- [ ] Update location description to mention it applies to RG resources

#### Activity Logs Section (4 tasks)
- [ ] Change default to "Yes (Recommended)" - now works!
- [ ] Update tooltip: "Automatically configures subscription activity logs (now supported)"
- [ ] Remove warning about failures
- [ ] Add success message about automatic configuration

#### Outputs Section (2 tasks)
- [ ] Add `resourceGroupName` output mapping
- [ ] Ensure all existing outputs still map correctly

#### Validation (3 tasks)
- [ ] Update `_edgeDeltaVersion` to `1.0.12`
- [ ] Test UI in sandbox mode
- [ ] Verify resource selectors work

### Phase 3: Safety Mechanisms

#### What-If Script (6 tasks)
- [ ] Create `tests/test-whatif.sh`
- [ ] Add template validation command
- [ ] Add what-if preview command
- [ ] Add interactive prompt to continue
- [ ] Add colored output for readability
- [ ] Make executable (`chmod +x`)

#### Cleanup Scripts (11 tasks)
- [ ] Create `tests/cleanup.sh` (Bash version)
- [ ] Add function to list diagnostic settings
- [ ] Add function to delete diagnostic settings by pattern
- [ ] Add warning banner: "FOR LOCAL DEVELOPMENT - Use with caution"
- [ ] Add interactive confirmations for all deletions
- [ ] Make executable (`chmod +x`)
- [ ] Create `tests/cleanup.ps1` (PowerShell version)
- [ ] Mirror all bash functionality in PowerShell
- [ ] Add colored output for both scripts
- [ ] Add usage examples in script headers
- [ ] Document in README when to use cleanup scripts

#### Validation Updates (4 tasks)
- [ ] Update `validate-all.sh` to use `az deployment sub validate`
- [ ] Add subscription-level what-if test
- [ ] Update test parameter files for subscription deployment
- [ ] Add usage documentation to validation scripts

### Phase 4: Documentation Updates

#### README - Deployment Commands (5 tasks)
- [ ] Update Azure CLI commands to `az deployment sub create`
- [ ] Update PowerShell commands to `New-AzDeployment`
- [ ] Add `--location` parameter (required for subscription deployments)
- [ ] Add `resourceGroupName` parameter to examples
- [ ] Add what-if examples before deployment examples

#### README - Parameters Table (3 tasks)
- [ ] Add `resourceGroupName` row (note: must be existing RG)
- [ ] Update `configureActivityLogs` default to `true`
- [ ] Update `configureActivityLogs` description (now works!)

#### README - Post-Deployment Steps (3 tasks)
- [ ] Update step 2 to reflect automatic activity log configuration
- [ ] Remove manual configuration steps (no longer needed)
- [ ] Add verification steps for activity logs

#### README - New Sections (5 tasks)
- [ ] Add "Prerequisites" section (existing RG required + subscription-level permissions)
- [ ] Add "Testing Before Deployment" section with what-if
- [ ] Add "Troubleshooting Failed Deployments" section
- [ ] Add "Cleanup Procedures" section with script usage
- [ ] Add warning that cleanup scripts are for local dev/testing

#### README - Examples (4 tasks)
- [ ] Update "Create All New Resources" example
- [ ] Update "Use Existing Namespace" example
- [ ] Update "Use Existing Storage" example
- [ ] Add "Use Existing Resource Group" example

#### Main Repository README (2 tasks)
- [ ] Update Deploy to Azure URL to v1.0.12
- [ ] Update description to mention subscription-level deployment

### Phase 5: Testing

#### Pre-Deployment Validation (5 tasks)
- [ ] Validate JSON syntax for azuredeploy.json
- [ ] Validate JSON syntax for createUiDefinition.json
- [ ] Run jq validation on all JSON files
- [ ] Check ARM template schema validation
- [ ] Run Azure template validation locally

#### What-If Testing (5 tasks)
- [ ] Test what-if with existing resource group + all new resources
- [ ] Test what-if with existing resource group + existing namespace
- [ ] Test what-if with existing resource group + existing storage
- [ ] Test what-if with existing resource group + existing namespace + storage
- [ ] Verify what-if shows diagnostic settings creation

#### Deploy to Azure Button Testing (5 tasks)
- [ ] Test UI in sandbox mode
- [ ] Verify resource group selector appears
- [ ] Verify namespace selector works
- [ ] Verify storage selector works
- [ ] Verify all defaults populate correctly

#### Actual Deployment Testing (7 tasks)
- [ ] Create test resource group manually
- [ ] Deploy with existing RG + all new resources
- [ ] Verify Event Hub created and diagnostic settings created
- [ ] Verify activity logs flowing to Event Hub
- [ ] Deploy with existing RG + existing namespace
- [ ] Deploy with existing RG + existing storage
- [ ] Test with activity logs disabled

#### Cleanup Testing (3 tasks)
- [ ] Test cleanup.sh script on failed deployment
- [ ] Test cleanup.ps1 script on failed deployment
- [ ] Verify diagnostic settings deletion works with both scripts

### Phase 6: Deployment & Release

#### Version Management (4 tasks)
- [ ] Update all version numbers to 1.0.12
- [ ] Update all Deploy to Azure URLs with `v=1.0.12`
- [ ] Update createUiDefinition version to 1.0.12
- [ ] Update metadata.json version

#### Git Operations (6 tasks)
- [ ] Run pre-commit validation
- [ ] Commit changes with detailed message
- [ ] Create annotated git tag `v1.0.12`
- [ ] Push branch to GitHub
- [ ] Push tags to GitHub
- [ ] Create pull request with migration notes

#### Validation (6 tasks)
- [ ] Wait 10 minutes for GitHub CDN cache clear
- [ ] Test Deploy to Azure button from README
- [ ] Verify latest version loads in Azure Portal
- [ ] Test actual deployment in test subscription
- [ ] Verify outputs appear correctly
- [ ] Monitor for any issues

## Code Examples

### 1. Template Schema Change

```json
{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.12.0",
  "metadata": {
    "_generator": {
      "name": "Edge Delta",
      "version": "1.0.12.0"
    },
    "description": "Deploy Azure Event Hub infrastructure for Edge Delta integration at subscription level. Creates resource group, Event Hub namespace, Event Hub, consumer groups, access policies, storage account for checkpoint management, and automatically configures subscription activity logs.",
    "summary": "One-click subscription-level deployment of Azure Event Hub infrastructure with automatic activity log streaming for Edge Delta",
    "githubUsername": "edgedelta",
    "dateUpdated": "2025-10-17",
    "type": "QuickStart"
  }
}
```

### 2. New Parameters

```json
"parameters": {
  "resourceGroupName": {
    "type": "string",
    "metadata": {
      "description": "Name of existing resource group for Event Hub and storage resources (must exist before deployment)"
    }
  },
  "location": {
    "type": "string",
    "defaultValue": "eastus",
    "metadata": {
      "description": "Azure region for resources (resource group location will be used)"
    }
  },
  "configureActivityLogs": {
    "type": "bool",
    "defaultValue": true,
    "metadata": {
      "description": "Automatically configure Azure subscription activity logs to stream to this Event Hub"
    }
  }
  // ... existing parameters
}
```

### 3. Updated Variables

```json
"variables": {
  "consumerGroupName": "edgedelta-processors",
  "sendAuthRuleName": "AzureSendPolicy",
  "listenAuthRuleName": "EdgeDeltaListenPolicy",
  "checkpointContainerName": "edgedelta-checkpoints",
  "diagnosticSettingName": "[concat('edgedelta-activity-logs-', utcNow('yyyyMMddHHmmss'))]",
  "resourceGroupId": "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('resourceGroupName'))]"
}
```

### 4. Diagnostic Settings (Root Level)

```json
{
  "condition": "[parameters('configureActivityLogs')]",
  "type": "Microsoft.Insights/diagnosticSettings",
  "apiVersion": "2021-05-01-preview",
  "name": "[variables('diagnosticSettingName')]",
  "properties": {
    "eventHubAuthorizationRuleId": "[reference(resourceId(parameters('resourceGroupName'), 'Microsoft.Resources/deployments', 'eventHubResources'), '2022-09-01').outputs.sendAuthRuleId.value]",
    "eventHubName": "[parameters('eventHubName')]",
    "logs": [
      {"category": "Administrative", "enabled": true},
      {"category": "Security", "enabled": true},
      {"category": "ServiceHealth", "enabled": true},
      {"category": "Alert", "enabled": true},
      {"category": "Recommendation", "enabled": true},
      {"category": "Policy", "enabled": true},
      {"category": "Autoscale", "enabled": true},
      {"category": "ResourceHealth", "enabled": true}
    ]
  },
  "dependsOn": [
    "[resourceId('Microsoft.Resources/deployments', 'eventHubResources')]"
  ]
}
```

### 5. Nested Deployment for Resource Group Resources

```json
{
  "type": "Microsoft.Resources/deployments",
  "apiVersion": "2022-09-01",
  "name": "eventHubResources",
  "resourceGroup": "[parameters('resourceGroupName')]",
  "dependsOn": [],
  "properties": {
    "mode": "Incremental",
    "expressionEvaluationOptions": {
      "scope": "inner"
    },
    "parameters": {
      "location": {"value": "[parameters('location')]"},
      "useExistingNamespace": {"value": "[parameters('useExistingNamespace')]"},
      "eventHubNamespaceName": {"value": "[parameters('eventHubNamespaceName')]"},
      "eventHubSku": {"value": "[parameters('eventHubSku')]"},
      "eventHubName": {"value": "[parameters('eventHubName')]"},
      "partitionCount": {"value": "[parameters('partitionCount')]"},
      "messageRetentionInDays": {"value": "[parameters('messageRetentionInDays')]"},
      "useExistingStorageAccount": {"value": "[parameters('useExistingStorageAccount')]"},
      "storageAccountName": {"value": "[parameters('storageAccountName')]"}
    },
    "template": {
      "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
      "contentVersion": "1.0.0.0",
      "parameters": {
        // All parameters passed from parent
      },
      "variables": {
        // All variables
      },
      "resources": [
        // Event Hub namespace
        // Event Hub
        // Consumer groups
        // Authorization rules
        // Storage account
        // Blob container
      ],
      "outputs": {
        "sendAuthRuleId": {
          "type": "string",
          "value": "[resourceId('Microsoft.EventHub/namespaces/eventhubs/authorizationRules', parameters('eventHubNamespaceName'), parameters('eventHubName'), variables('sendAuthRuleName'))]"
        },
        "listenConnectionString": {
          "type": "string",
          "value": "[listKeys(resourceId('Microsoft.EventHub/namespaces/eventhubs/authorizationRules', parameters('eventHubNamespaceName'), parameters('eventHubName'), variables('listenAuthRuleName')), '2022-10-01-preview').primaryConnectionString]"
        },
        "sendConnectionString": {
          "type": "string",
          "value": "[listKeys(resourceId('Microsoft.EventHub/namespaces/eventhubs/authorizationRules', parameters('eventHubNamespaceName'), parameters('eventHubName'), variables('sendAuthRuleName')), '2022-10-01-preview').primaryConnectionString]"
        },
        "storageAccountKey": {
          "type": "string",
          "value": "[listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), '2023-01-01').keys[0].value]"
        }
      }
    }
  }
}
```

### 6. Updated Outputs

```json
"outputs": {
  "instructions": {
    "type": "string",
    "value": "Copy these values to your Edge Delta Azure Event Hub Source configuration. Activity logs are now automatically configured!"
  },
  "connectionString": {
    "type": "string",
    "value": "[reference(resourceId(parameters('resourceGroupName'), 'Microsoft.Resources/deployments', 'eventHubResources'), '2022-09-01').outputs.listenConnectionString.value]",
    "metadata": {
      "description": "Edge Delta Field: Connection String (required)"
    }
  },
  "consumerGroup": {
    "type": "string",
    "value": "[variables('consumerGroupName')]",
    "metadata": {
      "description": "Edge Delta Field: Consumer Group (optional)"
    }
  },
  "storageAccountName": {
    "type": "string",
    "value": "[parameters('storageAccountName')]",
    "metadata": {
      "description": "Edge Delta Field: Storage Account Name (optional)"
    }
  },
  "storageAccountKey": {
    "type": "string",
    "value": "[reference(resourceId(parameters('resourceGroupName'), 'Microsoft.Resources/deployments', 'eventHubResources'), '2022-09-01').outputs.storageAccountKey.value]",
    "metadata": {
      "description": "Edge Delta Field: Storage Account Key (optional)"
    }
  },
  "storageContainerName": {
    "type": "string",
    "value": "[variables('checkpointContainerName')]",
    "metadata": {
      "description": "Edge Delta Field: Storage Container Name (optional)"
    }
  },
  "azureDiagnosticConnectionString": {
    "type": "string",
    "value": "[reference(resourceId(parameters('resourceGroupName'), 'Microsoft.Resources/deployments', 'eventHubResources'), '2022-09-01').outputs.sendConnectionString.value]",
    "metadata": {
      "description": "Use this for Azure diagnostic settings (Send permission)"
    }
  },
  "resourceGroupName": {
    "type": "string",
    "value": "[parameters('resourceGroupName')]",
    "metadata": {
      "description": "Resource group where Event Hub and storage are deployed"
    }
  },
  "eventHubNamespace": {
    "type": "string",
    "value": "[parameters('eventHubNamespaceName')]",
    "metadata": {
      "description": "Event Hub namespace name"
    }
  },
  "eventHubName": {
    "type": "string",
    "value": "[parameters('eventHubName')]",
    "metadata": {
      "description": "Event Hub name"
    }
  },
  "activityLogsConfigured": {
    "type": "string",
    "value": "[if(parameters('configureActivityLogs'), 'Yes - Subscription activity logs are now streaming to Event Hub automatically', 'No - Manual configuration required')]",
    "metadata": {
      "description": "Whether subscription activity logs were automatically configured"
    }
  }
}
```

### 7. UI Definition - Resource Group Selector

```json
{
  "name": "resourceGroupConfig",
  "type": "Microsoft.Common.Section",
  "label": "Resource Group",
  "elements": [
    {
      "name": "prerequisiteInfo",
      "type": "Microsoft.Common.InfoBox",
      "options": {
        "icon": "Info",
        "text": "This deployment requires an existing resource group. The resource group must be created before starting this deployment."
      },
      "visible": true
    },
    {
      "name": "existingResourceGroup",
      "type": "Microsoft.Solutions.ResourceSelector",
      "label": "Select existing resource group",
      "resourceType": "Microsoft.Resources/resourceGroups",
      "toolTip": "Choose the resource group where Event Hub and storage resources will be deployed",
      "constraints": {
        "required": true
      },
      "visible": true
    }
  ]
}
```

## Safety Scripts

### test-whatif.sh

```bash
#!/bin/bash
# What-if testing script for subscription deployment

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
TEMPLATE_DIR="$(dirname "$SCRIPT_DIR")"
TEMPLATE_FILE="$TEMPLATE_DIR/azuredeploy.json"
LOCATION="${LOCATION:-eastus}"
RG_NAME="${RG_NAME:-edgedelta-test-rg}"
EH_NAMESPACE="test-eh-$(date +%s | tail -c 7)"
STORAGE_ACCOUNT="testchk$(date +%s | tail -c 8)"

echo -e "${BLUE}==========================================${NC}"
echo -e "${BLUE}Edge Delta Azure Event Hub${NC}"
echo -e "${BLUE}What-If Testing (Subscription Deployment)${NC}"
echo -e "${BLUE}==========================================${NC}"
echo

echo -e "${YELLOW}Testing Parameters:${NC}"
echo "  Location: $LOCATION"
echo "  Resource Group: $RG_NAME (will be created)"
echo "  Event Hub Namespace: $EH_NAMESPACE"
echo "  Storage Account: $STORAGE_ACCOUNT"
echo

# Step 1: Validate template
echo -e "${BLUE}1. Validating template...${NC}"
if az deployment sub validate \
  --location "$LOCATION" \
  --template-file "$TEMPLATE_FILE" \
  --parameters \
    resourceGroupName="$RG_NAME" \
    createNewResourceGroup=true \
    eventHubNamespaceName="$EH_NAMESPACE" \
    storageAccountName="$STORAGE_ACCOUNT" \
    location="$LOCATION" \
    configureActivityLogs=true \
  > /dev/null 2>&1; then
  echo -e "${GREEN}✓${NC} Template validation passed"
else
  echo -e "${RED}✗${NC} Template validation failed"
  exit 1
fi

# Step 2: Run what-if
echo
echo -e "${BLUE}2. Running what-if analysis...${NC}"
az deployment sub what-if \
  --location "$LOCATION" \
  --template-file "$TEMPLATE_FILE" \
  --parameters \
    resourceGroupName="$RG_NAME" \
    createNewResourceGroup=true \
    eventHubNamespaceName="$EH_NAMESPACE" \
    storageAccountName="$STORAGE_ACCOUNT" \
    location="$LOCATION" \
    configureActivityLogs=true

echo
echo -e "${BLUE}==========================================${NC}"
echo -e "${YELLOW}Review the changes above.${NC}"
echo -e "${BLUE}==========================================${NC}"
echo

# Step 3: Prompt to continue
read -p "Proceed with deployment? (y/n) " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
  echo -e "${BLUE}Deploying...${NC}"
  az deployment sub create \
    --name "edgedelta-deployment-$(date +%Y%m%d-%H%M%S)" \
    --location "$LOCATION" \
    --template-file "$TEMPLATE_FILE" \
    --parameters \
      resourceGroupName="$RG_NAME" \
      createNewResourceGroup=true \
      eventHubNamespaceName="$EH_NAMESPACE" \
      storageAccountName="$STORAGE_ACCOUNT" \
      location="$LOCATION" \
      configureActivityLogs=true

  echo
  echo -e "${GREEN}✓ Deployment complete!${NC}"
else
  echo -e "${YELLOW}Deployment cancelled.${NC}"
fi
```

### cleanup.sh

```bash
#!/bin/bash
# Cleanup script for failed subscription deployments

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${BLUE}==========================================${NC}"
echo -e "${BLUE}Edge Delta Deployment Cleanup${NC}"
echo -e "${BLUE}==========================================${NC}"
echo

# Function to list diagnostic settings
list_diagnostic_settings() {
  echo -e "${BLUE}Diagnostic settings containing 'edgedelta':${NC}"
  az monitor diagnostic-settings subscription list \
    --query "value[?contains(name, 'edgedelta')].{Name:name, EventHub:properties.eventHubName}" \
    -o table
}

# Function to delete diagnostic settings
delete_diagnostic_settings() {
  echo
  echo -e "${YELLOW}Deleting Edge Delta diagnostic settings...${NC}"

  SETTINGS=$(az monitor diagnostic-settings subscription list \
    --query "value[?contains(name, 'edgedelta')].name" -o tsv)

  if [ -z "$SETTINGS" ]; then
    echo -e "${GREEN}No Edge Delta diagnostic settings found.${NC}"
    return
  fi

  echo "$SETTINGS" | while read -r name; do
    echo -e "  Deleting: ${YELLOW}$name${NC}"
    az monitor diagnostic-settings subscription delete --name "$name" --yes
    echo -e "  ${GREEN}✓${NC} Deleted: $name"
  done

  echo -e "${GREEN}✓ All Edge Delta diagnostic settings deleted.${NC}"
}

# Function to delete resource group
delete_resource_group() {
  echo
  read -p "Enter resource group name to delete (or press Enter to skip): " rg_name

  if [ -z "$rg_name" ]; then
    echo -e "${YELLOW}Skipping resource group deletion.${NC}"
    return
  fi

  # Check if resource group exists
  if az group exists --name "$rg_name" | grep -q "true"; then
    echo -e "${YELLOW}Resource group '$rg_name' exists.${NC}"

    # List resources in the group
    echo -e "${BLUE}Resources in '$rg_name':${NC}"
    az resource list --resource-group "$rg_name" \
      --query "[].{Name:name, Type:type}" -o table

    echo
    read -p "Delete resource group '$rg_name' and all resources? (y/n) " -n 1 -r
    echo

    if [[ $REPLY =~ ^[Yy]$ ]]; then
      echo -e "${YELLOW}Deleting resource group '$rg_name'...${NC}"
      az group delete --name "$rg_name" --yes --no-wait
      echo -e "${GREEN}✓${NC} Resource group deletion initiated (running in background)"
    else
      echo -e "${YELLOW}Resource group deletion cancelled.${NC}"
    fi
  else
    echo -e "${RED}Resource group '$rg_name' does not exist.${NC}"
  fi
}

# Main cleanup flow
echo -e "${BLUE}What would you like to clean up?${NC}"
echo "  1) Diagnostic settings only"
echo "  2) Resource group only"
echo "  3) Both diagnostic settings and resource group"
echo "  4) View only (no deletion)"
echo

read -p "Enter choice (1-4): " -n 1 -r
echo
echo

case $REPLY in
  1)
    list_diagnostic_settings
    delete_diagnostic_settings
    ;;
  2)
    delete_resource_group
    ;;
  3)
    list_diagnostic_settings
    delete_diagnostic_settings
    delete_resource_group
    ;;
  4)
    list_diagnostic_settings
    echo
    read -p "Enter resource group name to view (or press Enter to skip): " rg_name
    if [ ! -z "$rg_name" ]; then
      if az group exists --name "$rg_name" | grep -q "true"; then
        echo -e "${BLUE}Resources in '$rg_name':${NC}"
        az resource list --resource-group "$rg_name" \
          --query "[].{Name:name, Type:type}" -o table
      else
        echo -e "${RED}Resource group '$rg_name' does not exist.${NC}"
      fi
    fi
    ;;
  *)
    echo -e "${RED}Invalid choice.${NC}"
    exit 1
    ;;
esac

echo
echo -e "${GREEN}✓ Cleanup complete.${NC}"
```

## Success Criteria

### Deployment Success
- [ ] Template validates without errors
- [ ] What-if shows expected resources
- [ ] Deploy to Azure button works in portal
- [ ] Resource group created (or uses existing)
- [ ] Event Hub namespace created
- [ ] Event Hub created with correct configuration
- [ ] Consumer group created
- [ ] Authorization rules created
- [ ] Storage account created
- [ ] Blob container created
- [ ] Diagnostic settings created at subscription level
- [ ] All outputs populated correctly

### Functional Success
- [ ] Activity logs flowing to Event Hub within 5 minutes
- [ ] Edge Delta can connect using connection string
- [ ] Checkpointing works with storage account
- [ ] Consumer group accessible

### Documentation Success
- [ ] All commands work as documented
- [ ] Examples run without modification
- [ ] What-if instructions clear
- [ ] Cleanup procedures work
- [ ] Troubleshooting guide helpful

## Migration Notes for Users

### Breaking Changes
- **Deployment commands changed**: Must use `az deployment sub create` instead of `az deployment group create`
- **Location parameter now required**: Must specify `--location` for subscription deployments
- **Resource group parameter added**: Must specify `resourceGroupName` parameter

### Benefits
- ✅ Automatic activity log configuration (no manual steps!)
- ✅ Can create resource group during deployment
- ✅ Single-click deployment truly automated
- ✅ Proper Azure architecture
- ✅ Better error handling and validation

### Migration Path
- Existing v1.0.11 deployments continue working
- New deployments use v1.0.12
- No changes to existing resources needed
- Can deploy v1.0.12 to new subscription/RG without affecting existing

## Timeline Estimate

- **Phase 0**: 30 minutes ✅ (IN PROGRESS)
- **Phase 1**: 3 hours (template restructuring is complex)
- **Phase 2**: 1 hour
- **Phase 3**: 2 hours
- **Phase 4**: 2 hours
- **Phase 5**: 3 hours (thorough testing)
- **Phase 6**: 1 hour

**Total**: ~12-13 hours of focused work

## Risk Assessment

### Low Risk
- Template syntax errors → Validation catches before deployment
- UI definition errors → Sandbox testing catches issues
- Documentation errors → Review process catches

### Medium Risk
- Nested deployment scope issues → Extensive testing required
- Output reference paths → Validate outputs work
- Resource dependencies → What-if testing shows issues

### Mitigation
- Comprehensive testing in dev subscription first
- What-if before every deployment
- Cleanup scripts ready
- Rollback plan (manual cleanup documented)

## Progress Tracking

**Started**: 2025-10-17
**Current Phase**: Phase 0 - Preparation & Setup
**Status**: In Progress

---

*This plan will be updated as implementation progresses. All checkboxes will be marked as tasks are completed.*
